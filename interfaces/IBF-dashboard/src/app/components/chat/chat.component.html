<ion-content scrollY="true">
  <app-dialogue-turn [isWarn]="isWarn">
    <p
      [innerHTML]="
        'chat-component.' + disasterTypeName + '.warn-label.message'
          | translate
            : {
                lastModelRunDate: lastModelRunDate,
                name: authService.displayName
              }
      "
    ></p>
    <app-about-btn
      [btnLabel]="
        'chat-component.' + disasterTypeName + '.about-button-label' | translate
      "
    ></app-about-btn>
    <app-ibf-guide-button></app-ibf-guide-button>
    <app-activation-log-button></app-activation-log-button>
    <app-export-view></app-export-view>
  </app-dialogue-turn>

  <!-- No event -->
  <app-dialogue-turn
    *ngIf="!eventState?.activeEvent && !eventState?.activeTrigger"
    isConnected="true"
  >
    <p
      [innerHTML]="
        'chat-component.' + disasterTypeName + '.no-event-no-trigger.welcome'
          | translate
            : {
                name: authService.displayName
              }
      "
    ></p>
    <p
      class="clear-out-message"
      *ngIf="!!clearOutMessage"
      [innerHTML]="clearOutMessage"
    ></p>
  </app-dialogue-turn>
  <!-- Active event -->
  <ng-container *ngIf="eventState?.activeEvent && eventState?.activeTrigger">
    <app-dialogue-turn
      *ngFor="let event of eventState?.events"
      [isTriggered]="event.thresholdReached"
      [isNotTriggered]="!event.thresholdReached"
      [isSelected]="event.eventName === eventState?.event?.eventName"
      isConnected="true"
    >
      <p *ngIf="event.activeTrigger && event.thresholdReached">
        <span
          [innerHTML]="
            'chat-component.' +
              disasterTypeName +
              '.active-event-active-trigger.welcome'
              | translate
                : {
                    name: authService.displayName,
                    startDate: event.startDate,
                    leadTime: event.firstLeadTimeLabel,
                    timeUnit: event.timeUnit,
                    disasterTypeLabel: disasterTypeLabel,
                    firstLeadTimeDate: event.firstLeadTimeDate,
                    eventName: event.eventName
                  }
          "
        ></span>
      </p>
      <p
        *ngIf="event.activeTrigger && otherLeadTimes"
        [innerHTML]="
          'chat-component.' +
            disasterTypeName +
            '.active-event-active-trigger.other-leadtimes'
            | translate
              : {
                  otherLeadTimes: otherLeadTimes
                }
        "
      ></p>

      <p
        *ngIf="event.activeTrigger && !event.thresholdReached"
        [innerHTML]="
          'chat-component.' +
            disasterTypeName +
            '.active-event-active-trigger.welcome-below-trigger'
            | translate
              : {
                  startDate: event.startDate,
                  firstLeadTimeDate: event.firstLeadTimeDate,
                  eventName: event.eventName
                }
        "
      ></p>

      <p
        *ngIf="showTyphoonLandfallText(event)"
        [innerHTML]="showTyphoonLandfallText(event)"
      ></p>

      <app-event-switcher [event]="event"></app-event-switcher>

      <p *ngIf="forecastInfo && country?.countryCodeISO3 === 'ZWE'">
        {{ forecastInfo }}
      </p>

      <p
        class="clear-out-message"
        *ngIf="!!clearOutMessage"
        [innerHTML]="clearOutMessage"
      ></p>
    </app-dialogue-turn>
  </ng-container>
  <!-- Old event -->
  <app-dialogue-turn *ngIf="eventService.isOldEvent()" isConnected="true">
    <p
      [innerHTML]="
        'chat-component.' +
          disasterTypeName +
          '.active-event-no-trigger.welcome'
          | translate
            : {
                name: authService.displayName,
                startDate: eventState?.event.startDate,
                endDate: eventState?.event.endDate,
                eventName: eventState?.event.eventName
              }
      "
    ></p>
    <p
      class="clear-out-message"
      *ngIf="!!clearOutMessage"
      [innerHTML]="clearOutMessage"
    ></p>
  </app-dialogue-turn>

  <ng-container
    *ngIf="eventState?.activeEvent && eventState?.event?.thresholdReached"
  >
    <ng-container *ngIf="eventState?.activeTrigger">
      <app-dialogue-turn
        *ngIf="
          activeAreas.length &&
          filteredStoppedAreas.length === 0 &&
          filteredActiveAreas.length === 0
        "
        isConnected="true"
        [isTriggered]="true"
      >
        <p
          [innerHTML]="
            'chat-component.' + disasterTypeName + '.active-event.overview'
              | translate
                : {
                    nrTriggeredAreas: activeAreas.length,
                    adminAreaLabelPlural: adminAreaLabelPlural,
                    eventName: eventState?.event?.eventName,
                    actionIndicator: actionIndicatorLabel
                  }
          "
        ></p>
        <ul>
          <li
            *ngFor="let area of activeAreas"
            class="clickable-area"
            (click)="selectArea(area)"
          >
            <p>
              {{ area.name }}
              <span *ngIf="area.nameParent">({{ area.nameParent }})</span> -
              <span *ngIf="actionIndicatorNumberFormat === 'decimal0'">{{
                area.actionsValue | number: '.0-0'
              }}</span
              ><span *ngIf="actionIndicatorNumberFormat === 'perc'">{{
                area.actionsValue | percent: '.0-0'
              }}</span>
            </p>
          </li>
        </ul>
        <p
          [translate]="
            'chat-component.' + disasterTypeName + '.active-event.instruction'
              | translate
          "
        ></p>
      </app-dialogue-turn>
      <app-dialogue-turn
        *ngIf="
          stoppedAreas.length &&
          filteredStoppedAreas.length === 0 &&
          filteredActiveAreas.length === 0
        "
        isConnected="true"
        [isStopped]="true"
      >
        <p
          [innerHTML]="
            'chat-component.' + disasterTypeName + '.stopped-event.overview'
              | translate
                : {
                    nrStoppedAreas: stoppedAreas.length,
                    adminAreaLabelPlural: adminAreaLabelPlural,
                    eventName: eventState?.event?.eventName,
                    actionIndicator: actionIndicatorLabel
                  }
          "
        ></p>
        <ul>
          <li
            *ngFor="let area of stoppedAreas"
            class="clickable-area"
            (click)="selectArea(area)"
          >
            <p>
              {{ area.name }}
              <span *ngIf="area.nameParent">({{ area.nameParent }})</span> -
              <span *ngIf="actionIndicatorNumberFormat === 'decimal0'">{{
                area.actionsValue | number: '.0-0'
              }}</span
              ><span *ngIf="actionIndicatorNumberFormat === 'perc'">{{
                area.actionsValue | percent: '.0-0'
              }}</span>
            </p>
          </li>
        </ul>
        <p
          [translate]="
            'chat-component.' + disasterTypeName + '.stopped-event.instruction'
              | translate
          "
        ></p>
      </app-dialogue-turn>
      <app-dialogue-turn
        *ngFor="let area of filteredStoppedAreas; first as isFirst"
        [isConnected]="true"
        [isStopped]="true"
      >
        <ion-button
          *ngIf="placeCode"
          (click)="revertAreaSelection()"
          color="ibf-no-alert-primary"
          size="small"
          class="ion-float-right"
        >
          <span class="ion-hide-sm-down">{{
            'chat-component.common.revert-selection' | translate
          }}</span>
          <ion-icon name="arrow-back" slot="start"></ion-icon>
        </ion-button>
        <p
          [innerHTML]="
            'chat-component.' + disasterTypeName + '.stopped-event.area'
              | translate
                : {
                    placeCodeName: area.name,
                    startDate: area.startDate,
                    stoppedDate: area.stoppedDate,
                    displayName: area.displayName || 'unknown',
                    parentName: getAreaParentString(area)
                  }
          "
        ></p>
        <ion-button
          (click)="openToggleTriggerPopup(area, false)"
          [disabled]="!area.activeTrigger"
          color="ibf-no-alert-primary"
          expand="block"
          [innerHTML]="
            'chat-component.common.reactivate-trigger-popup.' +
              hasEap() +
              '.header' | translate
          "
        ></ion-button>
      </app-dialogue-turn>
    </ng-container>
    <app-dialogue-turn
      actor="self"
      *ngFor="let area of filteredActiveAreas; first as isFirst"
      [isConnected]="!isFirst"
      [isTriggered]="true"
    >
      <ion-button
        *ngIf="placeCode"
        (click)="revertAreaSelection()"
        color="ibf-primary"
        size="small"
        class="ion-float-right"
      >
        <span class="ion-hide-sm-down">{{
          'chat-component.common.revert-selection' | translate
        }}</span>
        <ion-icon name="arrow-back" slot="start"></ion-icon>
      </ion-button>
      <form (submit)="submitEapAction(area.placeCode)">
        <ion-row>
          <ion-col size-lg="2" size-md="2" size-xs="2">
            <ion-img
              src="assets/icons/Alert_Chat_Black.svg"
              class="chat-icon"
            ></ion-img>
          </ion-col>
          <ion-col size-lg="10" size-md="10" size-xs="10">
            <ion-label
              [innerHTML]="
                'chat-component.' +
                  disasterTypeName +
                  '.active-event.place-name'
                  | translate
                    : {
                        adminAreaLabel: adminAreaLabel,
                        placeName: area.name,
                        parentName: getAreaParentString(area)
                      }
              "
            ></ion-label
            ><br />
            <ion-note size="small">
              <span
                [innerHTML]="
                  'chat-component.' + disasterTypeName + '.active-event.exposed'
                    | translate
                "
              ></span>
              <strong
                ><span *ngIf="actionIndicatorNumberFormat === 'decimal0'">
                  {{ area.actionsValue | number: '.0-0' }}
                </span>
                <span *ngIf="actionIndicatorNumberFormat === 'perc'">
                  {{ area.actionsValue | percent: '.0-0' }}</span
                >
              </strong>
            </ion-note>
            <br />
            <div
              *ngIf="disasterTypeSettings?.showMonthlyEapActions"
              class="ion-margin-bottom"
            >
              <ng-container
                *ngIf="forecastInfo && country?.countryCodeISO3 === 'KEN'"
              >
                <ion-note size="small" *ngIf="area?.eapActions as actions">
                  <span *ngIf="forecastInfo?.length"
                    >{{
                      'chat-component.drought.active-event.forecast-info.opening'
                        | translate
                    }}
                  </span>

                  <span *ngFor="let forecast of forecastInfo; last as isLast">
                    <strong>{{ forecast }}</strong
                    ><span *ngIf="!isLast">
                      {{
                        'chat-component.drought.active-event.forecast-info.and'
                          | translate
                      }}
                    </span>
                  </span>
                  {{ ' ' }}
                  <span
                    [innerHTML]="
                      getNumberOfActions(actions.length, forecastInfo?.length)
                    "
                  ></span>
                </ion-note>
              </ng-container>
            </div>
          </ion-col>
        </ion-row>
        <ion-list class="background-light">
          <ion-item
            *ngFor="let action of area.eapActions"
            class="ion-no-padding"
          >
            <ion-checkbox
              mode="ios"
              slot="start"
              color="ibf-primary"
              [checked]="action.checked"
              name="action.action"
              (ionChange)="
                changeAction(
                  area.placeCode,
                  action.action,
                  $event.detail.checked
                )
              "
            ></ion-checkbox>
            <ion-label class="action-label ion-text-wrap"
              ><strong>{{ action.aofLabel }}: </strong>{{ action.label
              }}<span *ngIf="action.month"
                ><strong>
                  ({{ action.monthLong[getRegion(area.placeCode)] }})</strong
                ></span
              >
            </ion-label>
          </ion-item>
        </ion-list>
        <ion-row class="ion-nowrap ion-align-items-center ion-margin-top">
          <ion-button
            [disabled]="area.submitDisabled"
            color="ibf-primary"
            type="submit"
            expand="block"
            class="submit-button"
            [innerHTML]="
              'chat-component.common.save-actions.submit-button-label'
                | translate
            "
          ></ion-button>
        </ion-row>
      </form>
      <ion-button
        (click)="openToggleTriggerPopup(area, true)"
        [disabled]="!area.activeTrigger"
        color="ibf-primary"
        expand="block"
        [innerHTML]="
          'chat-component.common.stop-trigger-popup.' + hasEap() + '.header'
            | translate
        "
      ></ion-button>
    </app-dialogue-turn>
  </ng-container>
</ion-content>
